# Kickstart configuration for Rocky Linux 9.5 minimal installation
# Generated by Anaconda.

# Language and keyboard settings
lang en_US.UTF-8
keyboard us
timezone Asia/Kolkata --utc

# Root password (change this for production use)
rootpw --iscrypted $6$j504x00D6.zX2Xf2$L0tH0f0x0w0S0k0u0v0y0z0A0B0C0D0E0F0G0H0I0J0K0L0M0N0O0P0Q0R0S0T0U0V0W0X0Y0Z0

# User account setup
user --name=packer --password=packer --groups=wheel --shell=/bin/bash

# Network configuration
network --bootproto=dhcp --activate --hostname=rocky9-packer

# Installation source (using mounted ISO)
url --url="file:///run/install/repo"

# Disk partitioning
clearpart --all --initlabel
autopart --type=plain

# Bootloader configuration
bootloader --location=mbr --boot-drive=sda

# Enable essential system services
services --enabled="sshd,NetworkManager" --disabled="firewalld"

# Poweroff after installation
reboot

# Package installation
%packages
@^minimal-environment
open-vm-tools

# Exclude unwanted packages properly
-aic94xx-firmware
-alsa-firmware
-alsa-sof-firmware
-biosdevname
-iwl*firmware
-libertas-usb8388-firmware
-b43-openfwwf
-ppp
-irqbalance
-microcode_ctl
-xfsdump
-xfsprogs
-iscsi-initiator-utils
-kernel-tools
-kernel-tools-libs
-firewalld*
%end

# Pre-installation commands (if needed)
%pre
echo "Starting pre-installation steps..."
%end

# Post-installation commands
%post --log=/var/log/kickstart-post.log
echo "Starting post-installation..."

# Grant packer user passwordless sudo access during installation
echo "packer ALL=(ALL) NOPASSWD: ALL" | tee -a /etc/sudoers.d/packer
chmod 0440 /etc/sudoers.d/packer

# Update system packages
dnf update -y
dnf install -y epel-release python3

# Enable SSH service
systemctl enable --now sshd

# Cleanup system before finalizing
dnf clean all
rm -rf /var/cache/dnf /tmp/*

# Disable SELinux (for testing purposes; set to enforcing in production)
sed -i 's/^SELINUX=.*/SELINUX=disabled/g' /etc/selinux/config

echo "Kickstart post-installation completed."
%end
